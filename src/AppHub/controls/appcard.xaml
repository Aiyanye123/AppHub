<?xml version="1.0" encoding="utf-8"?>
<UserControl x:Class="AppHub.Controls.AppCard" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:controls="clr-namespace:AppHub.Controls;assembly=AppHub">
  <FrameworkElement.Resources>
    <ResourceDictionary>
      <Storyboard x:Key="HoverEnter">
        <DoubleAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="-5" Duration="0:0:0.16">
          <DoubleAnimation.EasingFunction>
            <QuadraticEase EasingMode="EaseOut" />
          </DoubleAnimation.EasingFunction>
        </DoubleAnimation>
      </Storyboard>
      <Storyboard x:Key="HoverLeave">
        <DoubleAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.16">
          <DoubleAnimation.EasingFunction>
            <QuadraticEase EasingMode="EaseOut" />
          </DoubleAnimation.EasingFunction>
        </DoubleAnimation>
      </Storyboard>
      <Storyboard x:Key="CardReveal">
        <DoubleAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.2" />
        <DoubleAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" From="10" To="0" Duration="0:0:0.2">
          <DoubleAnimation.EasingFunction>
            <QuadraticEase EasingMode="EaseOut" />
          </DoubleAnimation.EasingFunction>
        </DoubleAnimation>
      </Storyboard>
      <Storyboard x:Key="PulseAnimation" RepeatBehavior="Forever">
        <DoubleAnimation Storyboard.TargetName="StatusIndicator" Storyboard.TargetProperty="Opacity" From="1" To="0.4" Duration="0:0:0.8" AutoReverse="True" />
      </Storyboard>
    </ResourceDictionary>
  </FrameworkElement.Resources>
  <Border Name="CardBorder" Padding="16" CornerRadius="12" BorderThickness="1.5" BorderBrush="{DynamicResource BorderBrush}" Background="{DynamicResource ProgramCardBgBrush}" Cursor="Hand" HorizontalAlignment="Stretch" MinHeight="92">
    <UIElement.RenderTransform>
      <TranslateTransform />
    </UIElement.RenderTransform>
    <UIElement.Effect>
      <DropShadowEffect BlurRadius="10" Opacity="0.06" ShadowDepth="2" Direction="270" />
    </UIElement.Effect>
    <FrameworkElement.Triggers>
      <EventTrigger RoutedEvent="Loaded">
        <BeginStoryboard Storyboard="{StaticResource CardReveal}" />
      </EventTrigger>
      <EventTrigger RoutedEvent="MouseEnter">
        <BeginStoryboard Storyboard="{StaticResource HoverEnter}" />
      </EventTrigger>
      <EventTrigger RoutedEvent="MouseLeave">
        <BeginStoryboard Storyboard="{StaticResource HoverLeave}" />
      </EventTrigger>
    </FrameworkElement.Triggers>
    <FrameworkElement.ContextMenu>
      <ContextMenu DataContext="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource Self}}">
        <MenuItem Header="启动" Command="{Binding LaunchCommand}" />
        <MenuItem Header="关闭" Command="{Binding CloseCommand}" IsEnabled="{Binding IsRunning}" />
        <MenuItem Header="强制结束" Command="{Binding ForceCloseCommand}" IsEnabled="{Binding IsRunning}" />
        <Separator />
        <MenuItem Header="打开所在位置" Command="{Binding OpenLocationCommand}" />
        <MenuItem Header="编辑" Command="{Binding EditCommand}" />
        <MenuItem Header="{Binding PinMenuText}" Command="{Binding TogglePinCommand}">
          <MenuItem.Icon>
            <TextBlock Text="📌" FontSize="12" />
          </MenuItem.Icon>
        </MenuItem>
        <Separator />
        <MenuItem Header="移除" Command="{Binding RemoveCommand}" />
      </ContextMenu>
    </FrameworkElement.ContextMenu>
    <Grid>
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="*" />
        <ColumnDefinition Width="Auto" />
      </Grid.ColumnDefinitions>
      <TextBlock Grid.ColumnSpan="2" Text="📌" Foreground="{DynamicResource AccentBrush}" FontSize="14" FontWeight="SemiBold" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,-2,0,0" ToolTip="置顶" Visibility="{Binding IsPinned, Converter={StaticResource BooleanToVisibilityConverter}}" />
      <Grid Grid.Column="0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        <Border Width="56" Height="56" CornerRadius="14" Background="{DynamicResource HoverBgBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
          <Image Stretch="Uniform" Margin="8" Source="{Binding Icon}" />
        </Border>
        <StackPanel Grid.Column="1" Margin="14,0,0,0" VerticalAlignment="Center">
          <TextBlock FontSize="15" FontWeight="SemiBold" Foreground="{DynamicResource TextBrush}" TextTrimming="CharacterEllipsis" Text="{Binding DisplayName}" />
          <TextBlock FontSize="12" Foreground="{DynamicResource SubtleTextBrush}" Margin="0,4,0,0" Text="{Binding GroupDisplayName}" />
          <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
            <Ellipse Name="StatusIndicator" Width="8" Height="8">
              <FrameworkElement.Style>
                <Style TargetType="{x:Type Ellipse}">
                  <Setter Property="Fill" Value="{DynamicResource SubtleTextBrush}" />
                  <Style.Triggers>
                    <DataTrigger Value="True" Binding="{Binding IsRunning}">
                      <Setter Property="Fill" Value="{DynamicResource SuccessBrush}" />
                    </DataTrigger>
                  </Style.Triggers>
                </Style>
              </FrameworkElement.Style>
            </Ellipse>
            <TextBlock FontSize="13" Foreground="{DynamicResource SubtleTextBrush}" Margin="8,0,0,0" Text="{Binding StatusText}" />
          </StackPanel>
        </StackPanel>
      </Grid>
      <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
        <Button Content="启动" Style="{StaticResource SuccessButton}" Padding="14,8" FontSize="13" Command="{Binding LaunchCommand}" />
        <Button Margin="10,0,0,0" Content="关闭" Style="{StaticResource SecondaryButton}" Padding="14,8" FontSize="13" Command="{Binding CloseCommand}" IsEnabled="{Binding IsRunning}" />
      </StackPanel>
    </Grid>
  </Border>
</UserControl>
