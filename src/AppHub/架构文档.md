# AppHub 架构文档

> 当前实现架构说明（WPF / .NET 8）

---

## 1. 架构总览
AppHub 采用典型分层结构：
- `Views/XAML`：界面与交互事件
- `ViewModels`：页面状态与命令协调
- `Services`：业务能力（目录、启动、进程、存储、图标、自启、刷新调度）
- `Infrastructure`：应用级基础设施（服务装配、日志、托盘、命令行）
- `Models`：配置与运行态数据模型
- `Helpers`：Windows 相关工具封装（路径、快捷方式、进程、注册表）

---

## 2. 关键模块与职责

### 2.1 Infrastructure
- `AppServices`：全局服务初始化与依赖装配
- `AppLogger`：文件日志写入、容量控制、日志清理
- `TrayIconService`：托盘驻留与菜单动作
- `CommandLineOptions`：启动参数解析（自启开关、日志目录）
- `ThemeService`：浅/深色主题资源切换

### 2.2 Services
- `AppCatalogService`：应用数据增删改查、排序、分组名枚举、检索
- `LaunchService`：应用启动与窗口激活逻辑（`NewInstance` / `FocusExisting`）
- `ProcessControlService`：状态采集、优雅关闭、强制结束
- `StatusRefreshScheduler`：刷新调度与立即刷新触发
- `StorageService`：`config.json` 原子写入 + 防抖保存 + 刷盘
- `IconService`：图标提取、缓存与自定义图标读取
- `AutoStartService`：注册表开机自启开关

### 2.3 ViewModels
- `OverviewViewModel`：总览页数据组织、排序/筛选、状态刷新联动
- `AppItemViewModel`：单卡片命令与状态封装
- `SettingsViewModel`：设置项双向绑定与落盘

---

## 3. 事件与数据流

### 3.1 状态刷新链路
1. `StatusRefreshScheduler` 定时触发或手动触发
2. `ProcessControlService.RefreshAllStatusAsync()` 采样进程状态
3. 通过 `ProcessStatusesChangedEventArgs` 一次性发布批量状态
4. `OverviewViewModel` 批量更新卡片运行态并刷新展示

### 3.2 启动链路
1. UI 命令触发 `LaunchService.Launch(appId)`
2. 根据 `AppSettings.LaunchBehavior` 选择策略：
   - `NewInstance`：直接 `Process.Start`
   - `FocusExisting`：尝试激活已运行窗口，激活失败返回错误
3. 成功后登记 PID、记录 `LastLaunchTime`、请求立即刷新

### 3.3 配置写入链路
1. ViewModel 修改设置或目录数据
2. 调用 `StorageService.ScheduleSave()`
3. 防抖后原子写入 `config.json`
4. 应用退出时 `FlushNow/Dispose` 强制落盘

---

## 4. 数据模型（当前字段）

### 4.1 ApplicationItem
- `Id`
- `DisplayName`
- `SourceType`
- `TargetPath`
- `ShortcutPath`
- `Arguments`
- `WorkingDirectory`
- `IconSource`
- `CustomIconPath`
- `SortIndex`
- `GroupId`
- `GroupName`
- `LastLaunchTime`
- `TrackProcess`
- `IsPinned`

### 4.2 AppSettings
- `AutoStart`
- `RefreshIntervalMs`
- `CloseGracePeriodMs`
- `AllowForceKill`
- `LaunchBehavior`
- `LogDirectory`
- `LogMaxSizeMb`
- `AlwaysOnTop`
- `IsDarkMode`

### 4.3 其他
- `AppConfig`：`SchemaVersion + Settings + Apps`
- `ProcessStatus`：`IsRunning + MatchedProcessIds + LastSeenTime`

---

## 5. UI 结构（当前）
- `mainwindow.xaml`：左侧导航 + 右侧内容区（总览 / 设置）
- `views/overviewpage.xaml`：搜索、分组筛选、卡片列表、刷新/主题切换
- `views/settingspage.xaml`：常规设置、行为设置、日志设置
- `views/dialogs/addappdialog.xaml`：添加应用
- `views/dialogs/editappdialog.xaml`：编辑应用（含分组与图标设置）
- `controls/appcard.xaml`：应用卡片

---

## 6. 日志与容量控制
- 日志文件命名：`yyyy-MM-dd.log`
- 容量策略：超限后删除“当日日志文件”，不清空历史全部日志
- 手动清理：设置页按钮调用 `AppLogger.DeleteAllLogs()` 删除 `*.log`

---

## 7. 项目结构（实际目录）
```text
AppHub_net8.0-windows10.0.19041.0/
  AppHub.sln
  设计文档.md
  架构文档.md
  src/
    AppHub/
      AppHub.csproj
      app.xaml
      mainwindow.xaml
      controls/
        appcard.xaml
      views/
        overviewpage.xaml
        settingspage.xaml
        dialogs/
          addappdialog.xaml
          editappdialog.xaml
      AppHub/
        App.cs
        MainWindow.cs
        Models/
        Services/
        ViewModels/
        Views/
        Infrastructure/
        Helpers/
  tests/
    AppHub.Tests/
      AppHub.Tests.csproj
      CoreBehaviorTests.cs
```

---

## 8. 约束与注意
- 仅支持 Windows 桌面
- 托盘依赖 WinForms `NotifyIcon`
- 图标提取依赖 `System.Drawing.Common`
- 当前配置 `SchemaVersion = 1`，未实现多版本迁移链路
