# AppHub 设计文档

> 轻量级 Windows 应用总览启动器（WPF / .NET 8）

---

## 1. 产品目标
AppHub 用于在 Windows 桌面集中管理常用应用，提供统一的启动、状态查看、关闭与配置能力，降低多应用日常切换成本。

当前代码目标：
- 快速添加并管理 `exe/lnk` 应用
- 提供稳定的启动、关闭、状态刷新链路
- 提供可落地的桌面交互（托盘、置顶、主题）
- 配置本地持久化、日志可控

---

## 2. 运行环境
- 平台：Windows 10 19041+ / Windows 11
- 框架：`.NET 8`（`net8.0-windows10.0.19041.0`）
- UI：WPF

---

## 3. 当前功能范围（以代码为准）

### 3.1 应用管理
- 添加应用：支持 `*.exe` 与 `*.lnk`
- 编辑应用：名称、分组、目标路径、参数、工作目录、进程跟踪、自定义图标
- 删除应用：带确认弹窗
- 排序：总览页拖拽排序（在可排序条件下）
- 置顶：支持应用置顶/取消置顶（影响排序优先级）

### 3.2 启动与关闭
- 启动行为支持两种策略：
  - `NewInstance`：总是新开实例
  - `FocusExisting`：优先切换到已运行窗口
- 关闭支持：
  - 优雅关闭（发送窗口关闭消息）
  - 超时后按设置决定是否强制结束
- 启动/关闭失败会在 UI 给出明确提示

### 3.3 状态刷新
- 通过调度器定时刷新运行状态（间隔可配置）
- 手动刷新按钮支持立即刷新
- 状态事件采用批量更新（`ProcessStatusesChangedEventArgs`）

### 3.4 总览交互
- 搜索：按应用名与分组名搜索
- 分组筛选：`全部分组` + 动态分组列表
- 卡片展示：图标、分组、运行状态、置顶标记、快捷操作
- 主题切换：浅色/深色模式切换

### 3.5 设置能力
- 开机自启动
- 窗口始终置顶
- 允许强制结束进程
- 刷新间隔、关闭等待时长
- 启动行为策略
- 日志目录、日志最大占用
- 打开日志目录
- 一键删除所有日志

### 3.6 托盘行为
- 主窗口关闭时默认隐藏到托盘，不直接退出进程
- 托盘菜单支持：打开窗口、退出应用

---

## 4. 配置与存储
- 配置文件：`%LocalAppData%\AppHub\config.json`
- 图标缓存：`%LocalAppData%\AppHub\icons\{app-id}.png`
- 日志目录：默认 `%LocalAppData%\AppHub\logs\`（可在设置页修改）

配置示例：
```json
{
  "schemaVersion": 1,
  "settings": {
    "autoStart": false,
    "refreshIntervalMs": 3000,
    "closeGracePeriodMs": 5000,
    "allowForceKill": true,
    "launchBehavior": 0,
    "logDirectory": "C:\\Users\\User\\AppData\\Local\\AppHub\\logs",
    "logMaxSizeMb": 200,
    "alwaysOnTop": false,
    "isDarkMode": false
  },
  "apps": [
    {
      "id": "00000000-0000-0000-0000-000000000000",
      "displayName": "MyApp",
      "sourceType": 0,
      "targetPath": "C:\\Tools\\MyApp.exe",
      "shortcutPath": null,
      "arguments": "",
      "workingDirectory": "C:\\Tools",
      "iconSource": 0,
      "customIconPath": null,
      "sortIndex": 0,
      "groupId": null,
      "groupName": "开发",
      "lastLaunchTime": null,
      "trackProcess": true,
      "isPinned": false
    }
  ]
}
```

---

## 5. 日志策略（当前实现）
- 当 `logMaxSizeMb = 0`：不限制日志占用
- 当总日志大小超限：自动删除“今日日志文件”（当前写入文件）
- 设置页提供“删除所有日志”按钮，可手动清空日志目录中的 `*.log`

---

## 6. 开机自启方案
- 注册表路径：`HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
- 仅作用于当前用户

---

## 7. 项目与测试
- 解决方案：`AppHub.sln`
- 主项目：`src\AppHub\AppHub.csproj`
- 测试项目：`tests\AppHub.Tests\AppHub.Tests.csproj`
- 当前测试覆盖方向：核心模型/参数解析/路径与检索基础行为

---

## 8. 已知约束
- 当前仅支持 Windows 桌面环境
- 图标提取依赖 `System.Drawing.Common`（本地桌面场景）
- 托盘能力依赖 `System.Windows.Forms.NotifyIcon`
